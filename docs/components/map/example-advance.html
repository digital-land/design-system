<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="robots" content="noindex, nofollow">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title></title>
    <link href="/static/stylesheets/dl-frontend.css" rel="stylesheet" media="all" />
    <link href="/static/stylesheets/styleguide.css" rel="stylesheet" media="all" />
    <link href="/static/stylesheets/vendor/govuk-accessible-autocomplete.min.css" rel="stylesheet" media="all" /><!-- should make this optional, no need to load if not showing a map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
    integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
    crossorigin="" />

    <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
        integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
        crossorigin=""></script>

    <script src="/static/javascripts/dl-maps.js"></script>
</head>

<body class="govuk-template__body app-example-page">
    <script>
        document.body.className = ((document.body.className) ? document.body.className +
            ' js-enabled' : 'js-enabled');
    </script>

<div class="dl-map__wrapper"><div 
        class="dl-map govuk-!-margin-top-3"
        id="aMap"
        data-module="boundary-map"
        style="height: 700px;"   
    >
        <noscript>To view this map, you need to enable JavaScript.</noscript>
    </div>
    <div class="dl-map__loader">
        <div class="dl-map__loader-msg">
            <div class="dl-map__spinning-loader"></div>
            <span class="govuk-!-font-size-24 govuk-!-margin-top-6">Loading brownfield land data</span>
        </div>
    </div>
    
    <div class="dl-map__side-panel">
        <p>test html</p>
    </div>
    
</div>


<div class="govuk-form-group">
  <div class="hover-box govuk-!-width-one-half"></div>
</div>

<script src="/static/javascripts/dl-frontend.js"></script>
<script>

(function(dlf) {
  console.log("dlf", dlf)

  const $hoverBox = document.querySelector('.hover-box')
  const $mapElement = document.querySelector('[data-module="boundary-map"]')
  exmap = new DLMaps.Map($mapElement).init({})

  //const dlf = DLFrontend

  function laBoundaryURL(st_geo_code) {
    return `https://raw.githubusercontent.com/digital-land/boundary-collection/master/collection/local-authority/${st_geo_code}/index.geojson`
  }

  function addProperty(feature, name, value) {
    if( feature.properties ) {
      feature.properties[name] = value
    }
  }
  
  var bs = [{"id": "local-authority-eng:STO", "statistical_geography": "E07000082", "name": "Stroud District Council", "count": 86}, {"id": "local-authority-eng:LEE", "statistical_geography": "E07000063", "name": "Lewes District Council", "count": 56}, {"id": "local-authority-eng:TAM", "statistical_geography": "E08000008", "name": "Tameside Metropolitan Borough Council", "count": 88}, {"id": "local-authority-eng:EAS", "statistical_geography": "E07000061", "name": "Eastbourne Borough Council", "count": 117}, {"id": "local-authority-eng:CRA", "statistical_geography": "E07000163", "name": "Craven District Council", "count": 43}, {"id": "local-authority-eng:WDO", "statistical_geography": "E07000052", "name": "West Dorset District Council", "count": 47}, {"id": "local-authority-eng:STV", "statistical_geography": "E07000243", "name": "Stevenage Borough Council", "count": 22}, {"id": "national-park-authority:Q4972284", "statistical_geography": "E26000007", "name": "Broads Authority", "count": 28}, {"id": "local-authority-eng:HRW", "statistical_geography": "E09000015", "name": "London Borough of Harrow", "count": 102}, {"id": "local-authority-eng:SSO", "statistical_geography": "E07000189", "name": "South Somerset District Council", "count": 59}, {"id": "local-authority-eng:TEW", "statistical_geography": "E07000083", "name": "Tewkesbury Borough Council", "count": 15}, {"id": "local-authority-eng:WGN", "statistical_geography": "E08000010", "name": "Wigan Metropolitan Borough Council", "count": 157}, {"id": "local-authority-eng:FYL", "statistical_geography": "E07000119", "name": "Fylde Borough Council", "count": 1}, {"id": "local-authority-eng:SEL", "statistical_geography": "E07000169", "name": "Selby District Council", "count": 61}, {"id": "local-authority-eng:BST", "statistical_geography": "E06000023", "name": "Bristol City Council", "count": 392}, {"id": "local-authority-eng:CON", "statistical_geography": "E06000052", "name": "Cornwall Council", "count": 167}, {"id": "local-authority-eng:DOV", "statistical_geography": "E07000108", "name": "Dover District Council", "count": 59}, {"id": "local-authority-eng:BNH", "statistical_geography": "E06000043", "name": "Brighton and Hove City Council", "count": 220}, {"id": "local-authority-eng:WDE", "statistical_geography": "E07000047", "name": "West Devon Borough Council", "count": 4}, {"id": "local-authority-eng:WYC", "statistical_geography": "E07000238", "name": "Wychavon District Council", "count": 22}, {"id": "local-authority-eng:WFT", "statistical_geography": "E09000031", "name": "London Borough of Waltham Forest", "count": 63}, {"id": "local-authority-eng:CHO", "statistical_geography": "E07000118", "name": "Chorley Borough Council", "count": 88}, {"id": "local-authority-eng:MSU", "statistical_geography": "E07000203", "name": "Mid Suffolk District Council", "count": 10}, {"id": "local-authority-eng:STO", "statistical_geography": "E07000082", "name": "Stroud District Council", "count": 86}, {"id": "local-authority-eng:WOC", "statistical_geography": "E07000237", "name": "Worcester City Council", "count": 57}, {"id": "local-authority-eng:AYL", "statistical_geography": "E07000004", "name": "Aylesbury Vale District Council", "count": 24}, {"id": "local-authority-eng:EPS", "statistical_geography": "E07000208", "name": "Epsom and Ewell Borough Council", "count": 16}, {"id": "local-authority-eng:BDF", "statistical_geography": "E06000055", "name": "Bedford Borough Council", "count": 112}, {"id": "development-corporation:Q6670544", "statistical_geography": "E51000001", "name": "London Legacy Development Corporation", "count": 3}, {"id": "local-authority-eng:NWA", "statistical_geography": "E07000218", "name": "North Warwickshire Borough Council", "count": 37}, {"id": "local-authority-eng:DAV", "statistical_geography": "E07000151", "name": "Daventry District Council", "count": 8}, {"id": "local-authority-eng:STE", "statistical_geography": "E06000021", "name": "Stoke-on-Trent City Council", "count": 213}, {"id": "local-authority-eng:IOS", "statistical_geography": "E06000053", "name": "Council of the Isles of Scilly", "count": 3}, {"id": "local-authority-eng:EDO", "statistical_geography": "E07000049", "name": "East Dorset District Council", "count": 29}, {"id": "local-authority-eng:DAL", "statistical_geography": "E06000005", "name": "Darlington Borough Council", "count": 13}, {"id": "local-authority-eng:BOT", "statistical_geography": "E07000136", "name": "Boston Borough Council", "count": 45}, {"id": "local-authority-eng:BRX", "statistical_geography": "E07000095", "name": "Broxbourne Borough Council", "count": 42}, {"id": "local-authority-eng:WNM", "statistical_geography": "E06000040", "name": "Royal Borough of Windsor and Maidenhead", "count": 32}, {"id": "local-authority-eng:COP", "statistical_geography": "E07000029", "name": "Copeland Borough Council", "count": 24}, {"id": "local-authority-eng:SHF", "statistical_geography": "E08000019", "name": "Sheffield City Council", "count": 365}, {"id": "local-authority-eng:SFT", "statistical_geography": "E08000014", "name": "Sefton Metropolitan Borough Council", "count": 56}, {"id": "local-authority-eng:NDE", "statistical_geography": "E07000043", "name": "North Devon District Council", "count": 82}, {"id": "local-authority-eng:HYN", "statistical_geography": "E07000120", "name": "Hyndburn Borough Council", "count": 38}, {"id": "local-authority-eng:CLD", "statistical_geography": "E08000033", "name": "Calderdale Metropolitan Borough Council", "count": 180}, {"id": "local-authority-eng:SUF", "statistical_geography": "E07000205", "name": "Suffolk Coastal District Council", "count": 19}, {"id": "local-authority-eng:TON", "statistical_geography": "E07000115", "name": "Tonbridge and Malling Borough Council", "count": 11}, {"id": "local-authority-eng:SHA", "statistical_geography": "E07000044", "name": "South Hams District Council", "count": 14}, {"id": "local-authority-eng:CAN", "statistical_geography": "E07000192", "name": "Cannock Chase District Council", "count": 91}, {"id": "local-authority-eng:WND", "statistical_geography": "E09000032", "name": "London Borough of Wandsworth", "count": 243}, {"id": "local-authority-eng:WLA", "statistical_geography": "E07000127", "name": "West Lancashire Borough Council", "count": 26}, {"id": "national-park-authority:Q72617988", "statistical_geography": "E26000006", "name": "Peak District National Park Authority", "count": 4}, {"id": "local-authority-eng:BNE", "statistical_geography": "E09000003", "name": "London Borough of Barnet", "count": 148}, {"id": "local-authority-eng:FOE", "statistical_geography": "E07000080", "name": "Forest of Dean District Council", "count": 57}, {"id": "local-authority-eng:TUN", "statistical_geography": "E07000116", "name": "Tunbridge Wells Borough Council", "count": 62}, {"id": "local-authority-eng:DER", "statistical_geography": "E06000015", "name": "Derby City Council", "count": 46}, {"id": "local-authority-eng:SNO", "statistical_geography": "E07000149", "name": "South Norfolk District Council", "count": 47}, {"id": "local-authority-eng:HAL", "statistical_geography": "E06000006", "name": "Halton Borough Council", "count": 34}, {"id": "local-authority-eng:SHN", "statistical_geography": "E08000013", "name": "St Helens Council", "count": 110}, {"id": "local-authority-eng:WAV", "statistical_geography": "E07000206", "name": "Waveney District Council", "count": 34}, {"id": "local-authority-eng:BBD", "statistical_geography": "E06000008", "name": "Blackburn with Darwen Borough Council", "count": 33}, {"id": "local-authority-eng:BAI", "statistical_geography": "E07000066", "name": "Basildon Borough Council", "count": 89}, {"id": "local-authority-eng:EHE", "statistical_geography": "E07000242", "name": "East Hertfordshire District Council", "count": 24}, {"id": "local-authority-eng:BNS", "statistical_geography": "E08000016", "name": "Barnsley Metropolitan Borough Council", "count": 49}, {"id": "local-authority-eng:POR", "statistical_geography": "E06000044", "name": "Portsmouth City Council", "count": 145}, {"id": "local-authority-eng:WLI", "statistical_geography": "E07000142", "name": "West Lindsey District Council", "count": 58}, {"id": "local-authority-eng:EAT", "statistical_geography": "E07000086", "name": "Eastleigh Borough Council", "count": 25}, {"id": "local-authority-eng:BDG", "statistical_geography": "E09000002", "name": "London Borough of Barking and Dagenham", "count": 63}, {"id": "development-corporation:Q20648596", "statistical_geography": "E51000002", "name": "Old Oak and Park Royal Development Corporation", "count": 79}, {"id": "local-authority-eng:SOX", "statistical_geography": "E07000179", "name": "South Oxfordshire District Council", "count": 48}, {"id": "local-authority-eng:ELM", "statistical_geography": "E07000207", "name": "Elmbridge Borough Council", "count": 78}, {"id": "local-authority-eng:BOS", "statistical_geography": "E07000033", "name": "Bolsover District Council", "count": 28}, {"id": "local-authority-eng:SLG", "statistical_geography": "E06000039", "name": "Slough Borough Council", "count": 111}, {"id": "local-authority-eng:TOB", "statistical_geography": "E06000027", "name": "Torbay Council", "count": 89}];
  

// const organisationHoverStyle = {
//   fillOpacity: 0.2,
//   weight: 2,
//   color: '#FFDD00',
//   fillColor: '#FFEE80'
// }

const organisationHoverStyle = {
  fillOpacity: 0.25,
  weight: 2,
  color: '#0b0c0c',
  fillColor: '#003078'
}

const organisationActiveStyle = {
  fillOpacity: 0.2,
  weight: 2,
  color: '#FFDD00',
  fillColor: '#FFEE80'
}

const brownfieldSiteStyle = {
  color: "#745729",
  fillColor: "#745729",
  fillOpacity: 0.5
};

const historicalBrownfieldSiteStyle = {
  color: "#d53880 ",
  fillColor: "#f3f2f1",
  fillOpacity: 0.5
}

  function updateHoverBox(v, show=true) {
    if(show) {
      $hoverBox.textContent = v
    } else {
      if ($hoverBox.textContent === v) {
        $hoverBox.textContent = ""
      }
    }
  }

  function addHoverState (feature, layer) {
    console.log("hover states attached to", layer)
    console.log("which is a", typeof layer)
    layer.on('mouseover', function() {
      if(!Object.prototype.hasOwnProperty.call(layer, "parentId") || !layer.parentId.activeBoundary) {
        layer.setStyle(organisationHoverStyle)
        console.log(feature)
        updateHoverBox(feature.properties.organisation_name)
      }
    })
    layer.on('mouseout', function() {
      if(!Object.prototype.hasOwnProperty.call(layer, "parentId") || !layer.parentId.activeBoundary) {
        layer.setStyle(exmap.styles.defaultBoundaryStyle)
        updateHoverBox(feature.properties.organisation_name, false)
      }
    })
  }

  L.Path.prototype.setOnParentLayer = function(prop, val) {
    const layer = this
    if(Object.prototype.hasOwnProperty.call(layer, "parentId")) {
      layer.parentId[prop] = val
    }
  }

  function brownfield_data_url(organisation){
    orgDir = dlf.utils.curie_to_url_part(organisation)
    return `https://raw.githubusercontent.com/digital-land/dataset/master/docs/brownfield-land/organisation/${orgDir}/sites.geojson`
  }

  function addLayerClickEvent(feature, layer) {
    layer.on('click', function(e) {
      console.log("load brownfield sites for", feature, "layer", layer)
      console.log(e)
      url = brownfield_data_url(feature.properties.organisation)
      exmap.zoomToLayer(layer)
      loadBrownfieldSites(url, feature.properties.organisation)
      // track which layer is active
      localAuthorityBoundaries.activeLayer = layer._leaflet_id
      localAuthorityBoundaries.eachLayer(function (layer) {
        layer.activeBoundary = false
        layer.setStyle(exmap.styles.defaultBoundaryStyle)
      })
      console.log("my parent is ", layer.parentId)
      layer.setOnParentLayer("activeBoundary", true)
      layer.parentId.setStyle(organisationActiveStyle)
    })
  }

  function authorityLayerControls(feature, layer) {
    // function is run for each boundary that is plotted
    //layer.activeBoundary = false
    console.log("creating:", layer)
    layer.on("add", function(e) {
      console.log("My parent is", )
      console.log(e)
    })
    addHoverState(feature, layer)
    addLayerClickEvent(feature, layer)
    var count = feature.properties['bfs_count'] || 100
    layer.bindTooltip(count.toString(), {permanent: true, direction:'center', className: "dl-map__org-label"}).openTooltip();
  }


  function siteSize(hectares) {
    if (isNaN(hectares)) {
        return 100;
    } else {
        return (Math.sqrt((hectares * 10000) / Math.PI))
    }
  }

  var bfsTooltipTemplate =
    '<div class="bfs">' +
    '{hasEndDate}' +
    '<div class="bfs__header">' +
    '<span class="govuk-caption-s">{site}</span>' +
    '<h3 class="govuk-heading-s bfs__addr">{site-address}</h3>' +
    '<span class="bfs__coords">{latitude},{longitude}</span>' +
    '</div>' +
    '<div class="govuk-grid-row bfs__key-data">' +
    '<dl class="govuk-grid-column-one-half">' +
    '<dt>Hectare</dt>' +
    '<dd>{hectares}</dd>' +
    '</dl>' +
    '<dl class="govuk-grid-column-one-half">' +
    '<dt>Dwellings</dt>' +
    '<dd>{isRange}</dd>' +
    '</dl>' +
    '</div>' +
    '<div class="bfs__meta">' +
    '<dl>' +
    '<dt>Organisation</dt>' +
    '<dd>{organisation}</dd>' +
    '</dl>' +
    '{extraData}' +
    '{datesSection}' +
    '</div>' +
    '{siteURL}' +
    '<div class="bfs__footer">' +
    'From resource: <a href="https://digital-land.github.io/resource/{resource}" class="govuk-link">{resourceTrunc}</a>' +
    '</div>' +
    '</div>';

  function hasEndDate(data) {
      if(data['end-date']) {
          return '<span class="bfs__end-banner">End date: ' + data['end-date'] + '</span>';
      }
      return "";
  }

  function isRange(data) {
      var str = data['minimum-net-dwellings'];
      if(data['minimum-net-dwellings'] != null) {
          if(parseInt(data['minimum-net-dwellings']) !== parseInt(data['maximum-net-dwellings']) || parseInt(data['maximum-net-dwellings']) === 0 ) {
              str = data['minimum-net-dwellings'] + "-" + data['maximum-net-dwellings'];
          }
          return str;
      }
      return ""
  }

  function datesSection(data) {
      var str = '<dl>' +
      '<dt>Date added</dt>' +
      '<dd>' + data['start-date'] + '</dd>' +
      '</dl>';
      return str;
  }

  function hasURL(urlField) {
    if(urlField) {
      return [
        '<div class="bfs__footer">',
          `<a href="${urlField}" class="govuk-link">See on authority website</a>.`,
        '</div>'
      ].join("\n")
    }
    return ""
  }

  function createBFSPopup(row) {
    // need to find a way to clone object that will work in more browsers
    processedData = {...row}
    processedData.isRange = isRange
    processedData.hasEndDate = hasEndDate
    processedData.datesSection = datesSection
    processedData.resourceTrunc = dlf.utils.truncate(row['resource'], 9)
    processedData.siteURL = hasURL(row['site-plan-url'])
    var extraData = ""
    var potentiallyNullFields = ["deliverable", "hazardous-substances", "ownership", "planning-permission-status", "planning-permission-type"]
    potentiallyNullFields.forEach(function(field) {
      if(!!row[field]) {
        extraData += [
        '<dl>',
          `<dt>${field}</dt>`,
          `<dd>${row[field]}</dd>`,
        '</dl>' 
        ].join("\n")
      }
    })
    processedData.extraData = extraData
    return L.Util.template(bfsTooltipTemplate, processedData); 
  }

  function bfsControls(feature, layer) {
    var popupHTML = createBFSPopup(feature.properties)
    layer.bindPopup(popupHTML, {
      minWidth: "270",
      maxWidth: "270",
      className: "bfs-popup"
    })
    .on("popupopen", function(e) {
      console.log("Brownfield site selected", e.sourceTarget.feature)
    })
  }

  function plotBFS(feature, latlng) {
    var style = (feature.properties['end-date']) ? historicalBrownfieldSiteStyle : brownfieldSiteStyle
    console.log("historic", Boolean(feature.properties['end-date']))
    var size = siteSize(feature.properties['hectares'])
    style.radius = size.toFixed(2)
    //layer.setStyle(style)
    return L.circle(latlng, style);
  }


  var localAuthorityBoundaries = exmap.createFeatureGroup("localAuthorityBoundaries").addTo(exmap.map)
  var brownfieldSiteGroups = exmap.createFeatureGroup('brownfieldSiteGroups').addTo(exmap.map)


  function loadBrownfieldSites(url, organisation) {
    organisationCC = dlf.utils.toCamelCase(organisation)
    if (exmap.featureGroups.hasOwnProperty(organisationCC)) {
      // no need to fetch if we've done that before
      console.log("collected before")
    } else {
      console.log("fetch from url", url)
      fetch(url)
      .then(resp => resp.json())
      .then((data) => {
        var l = exmap.createFeatureGroup(organisationCC)
        L.geoJSON(data, {
          pointToLayer: plotBFS,
          onEachFeature: bfsControls
        })
        .addTo(l)
        l.addTo(brownfieldSiteGroups)
        console.log(data)
      })
      .catch(function(err) {
        console.log('error', err)
      })
    }
    
  }

  var failing = []
  Promise.allSettled(
    bs.map(function(b) {
      const url = laBoundaryURL(b.statistical_geography)
      return fetch(url)
        .then(resp => resp.json())
        .then((data) => {
          addProperty(data.features[0], "organisation", b.id)
          addProperty(data.features[0], "organisation_name", b.name)
          addProperty(data.features[0], "bfs_count", b.count)
          //addProperty(data.features[0], "name", b.name)
          console.log(data)
          var boundary = L.geoJSON(data, {
            style: exmap.styles.defaultBoundaryStyle,
            onEachFeature: authorityLayerControls
          })
          .on("add", function(e) {
            const parentLayer = e.target
            parentLayer.activeBoundary = false
            console.log("Parent layer", parentLayer._leaflet_id)
            for (var prop in parentLayer._layers) {
              if (Object.prototype.hasOwnProperty.call(parentLayer._layers, prop)) {
                const childLayer = parentLayer._layers[prop]
                console.log(childLayer)
                childLayer.parentId = localAuthorityBoundaries.getLayer(parentLayer._leaflet_id)
              }
            }
          })
          .addTo(localAuthorityBoundaries)
          return boundary
        })
        .catch(function(err) {
          console.log('error', err)
          failing.push([b.id, b.statistical_geography])
        })
    }
  )).then(boundaries => {
    // after all boundaries collected then fitBounds of map
    exmap.map.fitBounds(localAuthorityBoundaries.getBounds())
    exmap.hideLoader()
  })


  exmap.map.on("zoom", function(e) {
    const zoomLevel = exmap.map.getZoom()
    if (zoomLevel > 7) {
      brownfieldSiteGroups.addTo(exmap.map)
    } else {
      brownfieldSiteGroups.remove()
    }
  })

})(window.DLFrontend)
</script>
    <script src="/static/javascripts/govuk/govuk-frontend.min.js"></script>
    <script>
        // initiate all GOVUK components
        window.GOVUKFrontend.initAll();
    </script>
    
    <script src="/static/javascripts/dl-frontend.js"></script>

    <script src="/static/javascripts/vendor/govuk-accessible-autocomplete.min.js"></script>

    <!-- should move this to dl-frontend.js -->
    <script>
        const $inputCopyElements = document.querySelectorAll('[data-module*="input-copy"]')
        $inputCopyElements.forEach(function ($input) {
            new window.DLFrontend.InputCopy($input).init()
        })
    </script>

    <script>
        const $picker = document.querySelector('#organisation-search')
        if ($picker) {
            accessibleAutocomplete.enhanceSelectElement({
                selectElement: $picker
            })
        }
    </script>
    
</body>
</html>